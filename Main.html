<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>GestionG - Control de Finanzas</title>
</head>
<body>
    <script>
        (async function verificarSesion() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            try {
                const response = await fetch('https://gestiong-production.up.railway.app/obtener-gastos', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('usuario_logueado');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error("Error de conexion:", error);
            }
        })();
    </script>
    <!-- Encabezado principal -->
    <header>Gestion de cuentas</header>

    <main class="dashboard">
        <!-- ============================================
             COLUMNA IZQUIERDA - Resumen y entradas
             ============================================ -->
        <div class="columna-izquierda">
            
            <!-- Seccion de resumen: muestra los calculos -->
            <section id="resumenes">
                <h3>Tu resumen</h3>
                <p>Sueldo: <span id="Mostrar-sueldo">0</span> COP</p>   
                <p>Ahorro Quincenal (10%): <span id="Ahorro-quincenal">0</span> COP</p>
                <p>Valor por clase: <span id="valor-clase">0</span> COP</p>
            </section>

            <!-- Entradas de informacion basica -->
            <section id="ingresos">
                <h3>Datos de ingresos</h3>
                <input type="number" id="num-clases" placeholder="Numero de clases dadas">
                <input type="number" id="CopQuincenal" placeholder="Sueldo en pesos">
                
                <textarea id="desc-ingreso" placeholder="Descripcion del ingreso (Ej: Bono Extra)" rows="2"></textarea>
            </section>
            
            <button id="botonGuardar">Guardar</button>
        </div>

        <!-- ============================================
             COLUMNA DERECHA - Planificador de gastos
        ============================================ -->
        <div class="columna-derecha">
            <section id="horario-gastos">
                <h2>Planificador de Gastos</h2>
                
                <!-- Gastos que son todos los meses -->
                <div class="seccion-gastos">
                    <h3>Gastos Fijos y Agenda</h3>
                    
                    <div class="fila-gasto">
                        <input type="date" id="fecha-gasto-real">
                        <input type="number" id="valor-gasto-real" placeholder="Monto $">
                    </div>

                    <div class="fila-gasto">
                        <textarea id="desc-gasto" placeholder="¿En que consistio este gasto?" rows="2" style="width: 100%;"></textarea>
                    </div>
                </div>

                <!-- Gastos variables del dia a dia -->
                <div class="seccion-gastos">
                    <h3>Gastos Variables</h3>
                    <input type="number" id="gasto-compras" placeholder="Mercado/Dia a dia">
                    <input type="number" id="gasto-antojos" placeholder="Antojos y salidas">
                </div>

                <!-- Seguimiento de deudas -->
                <div class="seccion-gastos">
                    <h3>Deudas</h3>
                    <input type="number" id="deuda-corto" placeholder="Celular (Corto plazo)">
                    <input type="number" id="deuda-largo" placeholder="Largo plazo">
                </div>

                <button id="botonCalcularGastos">Calcular Gastos</button>
            </section>

            <!-- Aqui se mostrara el calendario de pagos -->
            <section id="lista-proximos-pagos">
                <!--Contenedor flexible para titulo y boton de exportar-->
                <div class="header-historial">
                    <h2>Agenda de Pagos Quincenal</h2>
                    <button id="boton-exportar">Exportar</button>
                </div>
                
                <section id="seccion-historial">
                    <h2>Pestana de Historial</h2>
                    <div id="contenedor-historial">
                        <table id = "tabla-historial">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Descricion</th>
                                    <th>Costo</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpo-historial">
                                <tr>
                                    <td colspan="3" class="texto-centrado">Aun no hay registros en el historial.</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- Resumen del total acumulado -->
                         <div class="caja-total">
                            <strong>Total gastado: </strong>
                            <span id="total-gastado">$0</span>
                         </div>
                    <button id="botonBorrarHistorial" style="background-color: #dc3545;">Borrar Historial</button>
                </section>
                <div id="contenedor-agenda">
                    <p>Ingresa los datos y dale a "Calcular Gastos" para ver tu agenda.</p>
                </div>
            </section>
        </div>
    </main>
    <!--Contenedor para notificaciones flotantes-->
    <div id="notificacion-container" class="notificacion-hidden">
        <span id="notificacion-mensaje"></span>
    </div>

    <!--Modal de confirmacion personalizado-->
    <div id="custom-modal" class="modal-hidden">
        <div class="modal-content">
            <h3>¿Estas seguro?</h3>
            <p id="modal-texto">Esta accion no se podra deshacer.</p>
            <div class="modal-actions">
                <button id="modal-confirmar" class="btn-danger">Confirmar</button>
                <button id="modal-cancelar" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    <!--Llamado del script-->
    <script src="script.js"></script>
    <script>
        const userLogueado = localStorage.getItem('usuario_logueado');
        if (userLogueado) {
            const displayUsuario = document.getElementById('nombre-usuario-display');
            if (displayUsuario) {
                displayUsuario.textContent = userLogueado;
            } else {
                const header = document.querySelector('header');
                if (header) {
                    header.innerHTML += ' - Bienvenido, <strong>' + userLogueado + '</strong>';
                }
            }
        }

        async function cerrarSesion() {
            localStorage.removeItem('usuario_logueado');
            localStorage.removeItem('auth_token');
            window.location.href = 'index.html';
        }
    </script>
</body>